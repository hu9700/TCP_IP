ICMP internet control message protocol
|		IP fragment		|
|IP header	|ICMP packet|

ICMP packet
0		   7 8		  15 16					   31
|8bit type	|8bit code	|16bit crc				|
-------------------------------------------------
|different type and code with different content	|

ICMP type
type	code	description						|查询	|差错	|处理方法		
-----------------------------------------------------------------
0		0		回显应答( Ping应答,第7章)			|	。	|		|用户进程
-----------------------------------------------------------------
3				目的不可达:						|		|	。	|
		0		网络不可达( 9.3节)					|		|	。	|“无路由到达主机”
		1		主机不可达						|		|	。	|“无路由到达主机”
		2		协议不可达						|		|	。	|“连接被拒绝”
		3		端口不可达( 6.5节)					|		|	。	|“连接被拒绝”
		4		需要进行分片但设置了不分片比特(11.6节	|		|	。	|“报文太长”
		5		源站选路失败( 8.5节)				|		|	。	|“无路由到达主机”
		6		目的网络不认识						|		|	。	|“无路由到达主机”
		7		目的主机不认识						|		|	。	|“无路由到达主机”
		8		源主机被隔离(作废不用)				|		|	。	|“无路由到达主机”
		9		目的网络被强制禁止					|		|	。	|“无路由到达主机”
		10		目的主机被强制禁止					|		|	。	|“无路由到达主机”
		11		由于服务类型TOS,网络不可达( 9.3节)	|		|	。	|“无路由到达主机”
		12		由于服务类型 TOS,主机不可达( 9.3节)	|		|	。	|“无路由到达主机”
		13		由于过滤,通信被强制禁止				|		|	。	|（忽略）
		14		主机越权							|		|	。	|（忽略）
		15		优先权中止生效						|		|	。	|（忽略）
-----------------------------------------------------------------
4		0		源端被关闭(基本流控制, 11.11节)		|		|	。	|TCP由内核处理, UDP则忽略
-----------------------------------------------------------------
5				重定向(9.5节)						|		|	。	|
		0		对网络重定向						|		|	。	|内核更新路由表
		1		对主机重定向						|		|	。	|内核更新路由表
		2		对服务类型和网络重定向				|		|	。	|内核更新路由表
		3		对服务类型和主机重定向				|		|	。	|内核更新路由表
-----------------------------------------------------------------
8		0		请求回显( Ping请求,第7章)			|	.	|		|
-----------------------------------------------------------------
9		0		路由器通告( 9.6节)					|	.	|		|用户进程
10		0		路由器请求( 9.6节)					|	.	|		|用户进程
-----------------------------------------------------------------
11				超时:
		0		传输期间生存时间为 0(Traceroute		|		|	.	|用户进程
		1		在数据报组装期间生存时间为 0			|		|	.	|用户进程
-----------------------------------------------------------------
12				参数问题:							
		0		坏的IP首部(包括各种差错)			|		|	.	|“协议不可用”
		1		缺少必需的选项						|		|	.	|“协议不可用”
-----------------------------------------------------------------
13		0		时间戳请求( 6.4节)					|	.	|		|内核产生应答
14		0		时间戳应答( 6.4节)					|	.	|		|用户进程
-----------------------------------------------------------------
15		0		信息请求(作废不用					|	.	|		|（忽略）
16		0		信息应答(作废不用)					|	.	|		|用户进程
-----------------------------------------------------------------
17		0		地址掩码请求( 6.3节)				|	.	|		|内核产生应答
18		0		地址掩码应答( 6.3节)				|	.	|		|用户进程


ICMP地址掩码请求与应答
0			   7 8			  15 16						   31
|type(17 or 18)	|code(0)		|crc						|
-------------------------------------------------------------
|标示符							|序列号						|
-------------------------------------------------------------
|				32位子网掩码									|

ICMP时间戳请求与应答 返回UTC
0			   7 8			  15 16						   31
|type(13 or 14)	|code(0)		|crc						|
-------------------------------------------------------------
|标示符							|序列号						|
-------------------------------------------------------------
|发起时间戳													|
-------------------------------------------------------------
|接收时间戳													|
-------------------------------------------------------------
|传送时间戳													|


ICMP端口不可达差错
如果发送一个UDP，然后得到端口不可达差错，UDP首部需要包含在数据中

|					IP 数据报										|
						|				ICMP报文					|
									|	ICMP报文数据部分			|
|以太网首部	|IP首部		|ICMP首部	|产生差错的数据报IP首部	|UDP首部	|


0			   7 8			  15 16							  31
|类型（3）		|代码（0～15）	|				CRC				|
-----------------------------------------------------------------
|						未用（必须为0）							|
-----------------------------------------------------------------
|IP首部（包括选项）+ 原始IP数据报中数据的前8字节						|


ICM P“超时”报文
0			   7 8			  15 16							  31
|类型（11）		|代码（0或1）		|				CRC				|
-----------------------------------------------------------------
|						未用（必须为0）							|
-----------------------------------------------------------------
|IP首部（包括选项）+ 原始IP数据报中数据的前8字节						|

ICMP重定向报文
0			   7 8			  15 16							  31
|类型（5）		|代码（0～3）		|				CRC				|
-----------------------------------------------------------------
|						应该使用的路由IP地址						|
-----------------------------------------------------------------
|IP首部（包括选项）+ 原始IP数据报中数据的前8字节						|

I C M P重定向报文的接收者必须查看三个 I P地址:
(1)导致重定向的 I P地址(即 I C M P重定向报文的数据位于IP数据报的首部); 
(2)发送重定向报文的路由器的I P地址(包含重定向信息的 I P数据报中的源地址;
(3)应该采用的路由器 IP地址(在ICMP报文中的4~7字节

ICMP路由器发现报文
一般认为,主机在引导以后要广播或多播传送一份路由器请求报文。一台或更多台路由
器响应一份路由器通告报文。另外,路由器定期地广播或多播传送它们的路由器通告报文,
允许每个正在监听的主机相应地更新它们的路由表。

ICMP路由器请求报文
0			   7 8			  15 16							  31
|类型（10）		|代码（0）		|				CRC				|
-----------------------------------------------------------------
|						未用(置为0发送)							|

ICMP路由器通告报文格式
0			   7 8			  15 16							  31
|类型（9）		|代码（0）		|				CRC				|
-----------------------------------------------------------------
|地址数			|地址项长度（2）	|			生存时间				|
-----------------------------------------------------------------
|						路由器地址【1】							|
-----------------------------------------------------------------
|						优先级【1】								|
-----------------------------------------------------------------
|						路由器地址【2】							|
-----------------------------------------------------------------
|						优先级【2】								|
-----------------------------------------------------------------
|						。。。。。								|

地址数指的是报文中所含的地址数。
地址项大小指的是每个路由器地址 32 bit 字的数目,始终为 2。
生存期指的是通告地址有效的时间(秒数)

I P地址必须是发送路由器的某个地址。优先级是
一个有符号的 32 bit整数,指出该 I P地址作为默认路由器地址的优先等级,这是与子网上的其
他路由器相比较而言的。值越大说明优先级越高。优先级为 0 x 8 0 0 0 0 0 0 0说明对应的地址不能
作为默认路由器地址使用,尽管它也包含中通告报文中。优先级的默认值一般为 0。

ICMP不可达差错(需要分片)
0			   7 8			  15 16							  31
|类型（3）		|代码（4）		|				CRC				|
-----------------------------------------------------------------
| 未用（必须为0）					| 下一站网络的MTU					|
-----------------------------------------------------------------
|IP首部（包括选项）+ 原始IP数据报中数据的前8字节						|



ICMP源站抑制差错
0			   7 8			  15 16							  31
|类型（4）		|代码（0）		|				CRC				|
-----------------------------------------------------------------
| 未用（必须为0）					|								|
-----------------------------------------------------------------
|IP首部（包括选项）+ 原始IP数据报中数据的前8字节						|
